<div class="prose-guardian-settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>üõ°Ô∏è Prose Guardian</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">

            <!-- Module A: Fast Mode -->
            <h4>‚ö° Module A: Static Fixer (Fast Mode)</h4>
            <label class="checkbox_label" for="asf_fast_mode">
                <input type="checkbox" id="asf_fast_mode" />
                <span>Enable instant regex cleanup</span>
            </label>
            <small>Uses 51 ProsePolisher regex patterns to instantly replace AI clich√©s (&lt; 5ms, zero tokens)</small>

            <hr>

            <!-- Quality Mode -->
            <h4>üé® Quality Mode (AI Rewriting)</h4>
            <label class="checkbox_label" for="asf_quality_mode">
                <input type="checkbox" id="asf_quality_mode" />
                <span>Enable AI deep polish</span>
            </label>

            <div class="flex-container">
                <label for="asf_quality_interval">Run every</label>
                <input type="number" id="asf_quality_interval" class="text_pole" min="1" max="100" value="5" />
                <span>messages</span>
            </div>

            <label class="checkbox_label" for="asf_quality_manual">
                <input type="checkbox" id="asf_quality_manual" />
                <span>Manual trigger only</span>
            </label>

            <div style="margin: 15px 0;">
                <label for="asf_connection_profile">Use separate API/Model for Quality Mode:</label>
                <select id="asf_connection_profile" class="text_pole" style="width: 100%;">
                    <option value="">Use main chat connection</option>
                </select>
                <small>Optional: Use a cheaper/faster API for slop fixing (e.g., Gemini Flash)</small>
            </div>

            <hr>

            <!-- Constraint Rules -->
            <h4>üìè Writing Constraints</h4>

            <div class="flex-container alignitemsflexstart">
                <label for="asf_min_words">Word Count:</label>
                <div class="flex-container flexFlowColumn flexNoGap">
                    <div class="flex-container">
                        <span>Min:</span>
                        <input type="number" id="asf_min_words" class="text_pole" min="0" value="50" />
                    </div>
                    <div class="flex-container">
                        <span>Max:</span>
                        <input type="number" id="asf_max_words" class="text_pole" min="0" value="500" />
                    </div>
                </div>
            </div>

            <div class="flex-container alignitemsflexstart">
                <label for="asf_min_paragraphs">Paragraphs:</label>
                <div class="flex-container flexFlowColumn flexNoGap">
                    <div class="flex-container">
                        <span>Min:</span>
                        <input type="number" id="asf_min_paragraphs" class="text_pole" min="0" value="1" />
                    </div>
                    <div class="flex-container">
                        <span>Max:</span>
                        <input type="number" id="asf_max_paragraphs" class="text_pole" min="0" value="10" />
                    </div>
                </div>
            </div>

            <div class="flex-container alignitemsflexstart">
                <label for="asf_min_dialogues">Dialogues:</label>
                <div class="flex-container flexFlowColumn flexNoGap">
                    <div class="flex-container">
                        <span>Min:</span>
                        <input type="number" id="asf_min_dialogues" class="text_pole" min="0" value="0" />
                    </div>
                    <div class="flex-container">
                        <span>Max:</span>
                        <input type="number" id="asf_max_dialogues" class="text_pole" min="0" value="999" />
                    </div>
                </div>
            </div>

            <hr>

            <!-- Presets -->
            <h4>üíæ Presets</h4>
            <div style="margin: 15px 0;">
                <label for="asf_preset_select">Load Preset:</label>
                <div class="flex-container" style="gap: 5px;">
                    <select id="asf_preset_select" class="text_pole" style="flex: 1;">
                        <option value="">Select a preset...</option>
                    </select>
                    <button id="asf_load_preset" class="menu_button" title="Load selected preset">
                        <i class="fa-solid fa-upload"></i>
                    </button>
                    <button id="asf_delete_preset" class="menu_button" title="Delete selected preset">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <div style="margin: 15px 0;">
                <label for="asf_preset_name">Save As:</label>
                <div class="flex-container" style="gap: 5px;">
                    <input type="text" id="asf_preset_name" class="text_pole" placeholder="Enter preset name"
                        style="flex: 1;" />
                    <button id="asf_save_preset" class="menu_button" title="Save current settings as preset">
                        <i class="fa-solid fa-save"></i> Save
                    </button>
                </div>
                <small>Save your current configuration with a custom name</small>
            </div>

            <!-- UX Settings -->\n <h4>‚öôÔ∏è UX Settings</h4>

            <label class="checkbox_label" for="asf_auto_mode">
                <input type="checkbox" id="asf_auto_mode" />
                <span>Auto-mode: Apply changes automatically</span>
            </label>
            <small>When ON, changes are applied immediately. When OFF, you'll see a before/after comparison and can
                Accept or Reject changes.</small>

            <hr>

            <!-- Module B: Passive Watcher (Background Learning) -->
            <h4>üß† Module B: Passive Watcher (Automatic)</h4>
            <small>Automatically learns overused phrases in the background (always active, zero tokens)</small>

            <div style="margin: 15px 0; padding: 10px; background: var(--black30alpha); border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>Detected Overused Phrases:</strong></span>
                    <span id="asf_module_b_count"
                        style="font-size: 1.2em; font-weight: bold; color: var(--SmartThemeQuoteColor);">0</span>
                </div>
                <small style="opacity: 0.8;">Analyzes last 20 messages to detect repetitive patterns. Feeds Module C for
                    prevention.</small>
            </div>

            <hr>

            <!-- Module C: Proactive Injector (Prevention Mode) -->
            <h4>üõ°Ô∏è Module C: Proactive Injector (Prevention Mode)</h4>

            <label class="checkbox_label" for="asf_enable_injection">
                <input type="checkbox" id="asf_enable_injection" />
                <span>Enable Prevention Mode</span>
            </label>
            <small>Injects anti-slop instructions BEFORE AI generates (uses Module B + custom blacklist)</small>

            <div style="margin: 10px 0;">
                <label for="asf_injection_position">Injection Position:</label>
                <select id="asf_injection_position" class="text_pole" style="width: 100%;">
                    <option value="system">System Prompt (recommended)</option>
                    <option value="after_scenario">After Scenario</option>
                    <option value="before_user">Before User Message</option>
                </select>
            </div>

            <div style="margin: 10px 0;">
                <label for="asf_prevention_instructions">Prevention Instructions:</label>
                <textarea id="asf_prevention_instructions" class="text_pole" rows="6"
                    style="width: 100%; resize: vertical;"></textarea>
                <small>Instructions shown to AI before generation. Learned patterns are automatically added!</small>
            </div>

            <hr>

            <!-- Custom Phrase Blacklist -->
            <h4>üö´ Custom Phrase Blacklist</h4>
            <small>Manually block specific words/phrases from appearing in future AI messages</small>
            <div
                style="margin-top: 5px; padding: 8px; background: #5a3a3a; border-left: 3px solid #ff6b6b; border-radius: 3px;">
                <small style="color: #ffcccc;">
                    <strong>‚ö†Ô∏è Do NOT block character names!</strong> Blocking names like "Jensen", "Alex", etc. causes
                    the AI to use them MORE (backfire effect). Only block writing patterns like "heart raced", "eyes
                    widened".
                </small>
            </div>

            <div style="margin: 15px 0;">
                <div class="flex-container" style="gap: 5px;">
                    <input type="text" id="asf_custom_phrase_input" class="text_pole"
                        placeholder="Enter phrase to block (e.g., heart raced)" style="flex: 1;" />
                    <button id="asf_add_custom_phrase" class="menu_button" title="Add phrase to blacklist">
                        <i class="fa-solid fa-plus"></i> Add
                    </button>
                    <button id="asf_import_custom_phrases" class="menu_button"
                        title="Import multiple phrases from text">
                        <i class="fa-solid fa-file-import"></i> Import
                    </button>
                </div>
            </div>

            <div style="margin: 15px 0;">
                <strong>Blocked Phrases: <span id="asf_custom_phrase_count">0</span></strong>
                <button id="asf_export_custom_phrases" class="menu_button" title="Export phrases to text file"
                    style="margin-left: 10px;">
                    <i class="fa-solid fa-download"></i> Export
                </button>
                <button id="asf_clear_custom_phrases" class="menu_button caution"
                    title="Clear all custom blocked phrases" style="margin-left: 5px;">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>

            <div id="asf_custom_phrase_list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>

            <hr>

            <!-- Module D: AI Regex Generation -->
            <h4>ü§ñ AI-Powered Regex Generation (Module D)</h4>
            <small>Automatically create professional regex rules from detected patterns using AI</small>

            <!-- Module B Settings -->
            <div style="margin: 15px 0;">
                <label for="asf_module_b_window">Analysis Window (Module B messages):</label>
                <div class="flex-container" style="gap: 10px; align-items: center;">
                    <input type="number" id="asf_module_b_window" class="text_pole" min="10" max="100" value="20"
                        style="width: 80px;" />
                    <small>How many recent AI messages to analyze for patterns</small>
                </div>
            </div>

            <!-- Generation Controls -->
            <div style="margin: 15px 0;">
                <button id="asf_generate_rules" class="menu_button"
                    title="Use AI to generate regex rules from Module B's detected phrases">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Rules from Detected Phrases
                </button>
                <div style="margin-top: 5px;">
                    <small>
                        Detected patterns ready: <strong><span id="asf_detectable_count">0</span></strong>
                        ‚Ä¢ Dynamic rules: <strong><span id="asf_dynamic_rules_count">0</span></strong>
                    </small>
                </div>
            </div>

            <!-- Manual Add Rule -->
            <div style="margin: 15px 0;">
                <details>
                    <summary style="cursor: pointer; font-weight: bold;">‚ûï Manually Add Rule</summary>
                    <div
                        style="margin-top: 10px; padding: 10px; background: var(--SmartThemeBlurTintColor); border-radius: 5px;">
                        <div style="margin: 8px 0;">
                            <label>Rule Name:</label>
                            <input type="text" id="asf_manual_rule_name" class="text_pole"
                                placeholder="e.g., Slopfix - Heart Racing" />
                        </div>
                        <div style="margin: 8px 0;">
                            <label>Regex Pattern:</label>
                            <input type="text" id="asf_manual_rule_regex" class="text_pole"
                                placeholder="e.g., \b([Hh]is|[Hh]er|[Tt]heir)\s+heart\s+(raced|pounded)\b" />
                            <small>Use capture groups (...) for variations</small>
                        </div>
                        <div style="margin: 8px 0;">
                            <label>Replacement (comma-separated alternatives):</label>
                            <textarea id="asf_manual_rule_replacement" class="text_pole" rows="3"
                                placeholder="{{random:$1 pulse quickened,$1 chest tightened,$1 heartbeat echoed,...}}"></textarea>
                            <small>Format: {{random:alt1,alt2,alt3,...}} Use $1,$2 for capture groups</small>
                        </div>
                        <button id="asf_add_manual_rule" class="menu_button">
                            <i class="fa-solid fa-plus"></i> Add Rule
                        </button>
                    </div>
                </details>
            </div>

            <!-- Import/Export -->
            <div style="margin: 15px 0;">
                <button id="asf_import_dynamic_rules" class="menu_button" title="Import dynamic rules from JSON file">
                    <i class="fa-solid fa-file-import"></i> Import Rules
                </button>
                <button id="asf_export_dynamic_rules" class="menu_button" title="Export dynamic rules to JSON file">
                    <i class="fa-solid fa-download"></i> Export Rules
                </button>
                <button id="asf_clear_dynamic_rules" class="menu_button" title="Clear all AI-generated rules"
                    style="background: #a34343;">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>

            <!-- Dynamic Rules List -->
            <div style="margin: 15px 0;">
                <strong>Generated Rules:</strong>
                <div id="asf_dynamic_rules_list" style="margin-top: 10px; max-height: 300px; overflow-y: auto;"></div>
            </div>

            <hr>

            <!-- User Protection -->
            <h4>üõ°Ô∏è User Character Protection</h4>
            <label class="checkbox_label" for="asf_protect_user">
                <input type="checkbox" id="asf_protect_user" />
                <span>Protect {{user}} from AI control</span>
            </label>

            <label for="asf_user_names">User character names (comma-separated):</label>
            <textarea id="asf_user_names" class="text_pole" rows="2"
                placeholder="{{user}}, Raja, etc.">{{user}}</textarea>
            <small>AI will not control, speak for, or describe these characters</small>

            <hr>

            <!-- Formatting & Immersion -->
            <h4>‚ú® Formatting & Immersion</h4>

            <label class="checkbox_label" for="asf_visual_effects">
                <input type="checkbox" id="asf_visual_effects" />
                <span>Enable Visual Text Effects (Inline CSS)</span>
            </label>
            <small>Allows AI to use glows, blurs, and colors to visualize emotions</small>

            <label class="checkbox_label" for="asf_separate_dialogue">
                <input type="checkbox" id="asf_separate_dialogue" />
                <span>Force Dialogue Separation</span>
            </label>
            <small>Keeps dialogue on its own lines for better readability</small>

            <hr>

            <!-- Perspective -->
            <h4>üëÅÔ∏è Perspective</h4>
            <div class="flex-container">
                <label>
                    <input type="radio" name="asf_perspective" value="1st" />
                    1st Person (I, me)
                </label>
                <label>
                    <input type="radio" name="asf_perspective" value="2nd" />
                    2nd Person (you)
                </label>
                <label>
                    <input type="radio" name="asf_perspective" value="3rd" checked />
                    3rd Person (he/she/they)
                </label>
            </div>

            <hr>

            <!-- Debug Mode -->
            <h4>üêõ Debug Mode</h4>
            <label class="checkbox_label" for="asf_debug_mode">
                <input type="checkbox" id="asf_debug_mode" />
                <span>Enable debug logging</span>
            </label>
            <small>When enabled, detailed diagnostics will be captured for each message</small>

            <hr>

            <!-- Last Execution Details -->
            <h4>üìä Last Execution Details</h4>

            <div style="margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="asf_history_select">View History:</label>
                    <button id="asf_export_all_history" class="menu_button"
                        title="Export all original and rewritten text">
                        <i class="fa-solid fa-file-export"></i> Export All History
                    </button>
                </div>
                <select id="asf_history_select" class="text_pole" style="width: 100%;">
                    <option value="0">Most recent...</option>
                </select>
                <small>Select a previous run to view its diagnostics (last 20 runs stored)</small>
            </div>

            <div id="asf_diagnostics_status" style="margin: 10px 0; font-style: italic; opacity: 0.8;">
                No messages processed yet
            </div>

            <div class="flex-container alignitemsflexstart" style="margin: 15px 0;">
                <div style="flex: 1; margin-right: 10px;">
                    <label for="asf_original_text"><strong>Original Text:</strong></label>
                    <textarea id="asf_original_text" class="text_pole" rows="8" readonly
                        style="width: 100%; resize: vertical; background: var(--black30alpha); font-family: monospace; font-size: 12px;"></textarea>
                </div>
                <div style="flex: 1; margin-left: 10px;">
                    <label for="asf_rewritten_text"><strong>Rewritten Text:</strong></label>
                    <textarea id="asf_rewritten_text" class="text_pole" rows="8" readonly
                        style="width: 100%; resize: vertical; background: var(--black30alpha); font-family: monospace; font-size: 12px;"></textarea>
                </div>
            </div>

            <div style="margin: 15px 0;">
                <strong>Token Usage:</strong> <span id="asf_token_count" style="margin-left: 10px;">N/A</span>
            </div>

            <div style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="asf_debug_log"><strong>Debug Log:</strong></label>
                    <div style="display: flex; gap: 5px;">
                        <button id="asf_copy_log" class="menu_button" title="Copy debug log to clipboard">
                            <i class="fa-solid fa-copy"></i> Copy
                        </button>
                        <button id="asf_export_log" class="menu_button" title="Export debug log as text file">
                            <i class="fa-solid fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <textarea id="asf_debug_log" class="text_pole" rows="12" readonly
                    style="width: 100%; resize: vertical; background: var(--black30alpha); font-family: monospace; font-size: 11px;"></textarea>
            </div>

        </div>
    </div>
</div>